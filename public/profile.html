<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Profile</title>
    <link rel="stylesheet" href="/css/blackstream.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <!-- Main Navigation -->
    <nav>
        <li><a href="/">Home</a></li>
        <li><a href="/profile">Profile</a></li>
        <li><a href="/logout">Logout</a></li>
    </nav>

    <!-- Main Content Container -->
    <main>
        <!-- Profile Window -->
        <div class="window">
            <h1>Profile</h1>
            <div class="flex-row">
                <img id="profilePicture" src="" alt="Profile Picture" style="width:64px;height:64px;">
                <div class="flex-column">
                    <h2 id="username">loading...</h2>
                    <p>Steam ID / Email: <span id="identifier">loading...</span></p>
                    <p>ELO Rating: <span id="skill">loading...</span></p>
                </div>
                <button class="greensteam-button" id="toggleCodeVisibility" title="Show Code" style="margin-left: 8px;" aria-label="Reveal invite code">üëÅ</button>
              </div>
            </div>
        </div>

        <!-- Matchmaking Window -->
        <div class="window">
            <h2>Matchmaking</h2>
            <button id="startMatchmakingBtn" class="greensteam-button">Start Matchmaking</button>
        </div>

        <!-- Pre-Lobby Window -->
        <div class="window">
            <h2>Pre-Lobby</h2>
            <div class="flex-column">
                <button id="createPreLobbyBtn" class="greensteam-button">Create Pre-Lobby</button>
                <div class="border inset" style="padding: 10px; margin: 10px 0;">
                    <h3>Join Pre-Lobby</h3>
                    <input type="text" id="inviteCodeInput" placeholder="Enter invite code">
                    <button id="joinPreLobbyBtn" class="greensteam-button">Join</button>
                </div>
            </div>
        </div>

        <!-- Active Pre-Lobby Window -->
        <div id="preLobbySection" class="window" style="display: none;">
            <h2>Active Pre-Lobby</h2>
            <p>Invite Code: <span id="inviteCode"></span></p>
            <div id="preLobbyPlayerList" class="border inset" style="padding: 10px; margin: 10px 0;">
                <!-- Players will be dynamically inserted here -->
            </div>
                        <button id="startPreLobbyMatchmakingBtn" class="greensteam-button" style="display: none;">
                Start Matchmaking
            </button>
        </div>
    </main>

    <script>
        const socket = io();
        
        async function fetchUserInfo() {
            try {
                const [userInfo, skillInfo] = await Promise.all([
                    fetch('/user/info').then(r => r.json()),
                    fetch('/user/skill').then(r => r.json())
                ]);
                
                document.getElementById('username').textContent = userInfo.username || 'Unknown user';
                document.getElementById('identifier').textContent = userInfo.steamId || userInfo.email || 'No ID';
                document.getElementById('skill').textContent = skillInfo.skill || 'Unrated';
                
                if (userInfo.profilePictureUrl) {
                    const profilePicture = document.getElementById('profilePicture');
                    profilePicture.src = userInfo.profilePictureUrl;
                    profilePicture.style.display = 'block';
                }
                
                return { ...userInfo, skill: skillInfo.skill };
            } catch (error) {
                console.error('Error fetching user info:', error);
                return null;
            }
        }
    
        // Update create/join pre-lobby handlers
        document.getElementById('createPreLobbyBtn').addEventListener('click', async () => {
            const userInfo = await fetchUserInfo();
            socket.emit('createPreLobby', userInfo);
        });
    
        document.getElementById('joinPreLobbyBtn').addEventListener('click', async () => {
            const inviteCode = document.getElementById('inviteCodeInput').value;
            const userInfo = await fetchUserInfo();
            socket.emit('joinPreLobby', { inviteCode, user: userInfo });
        });
    
        // Update pre-lobby display handler
        socket.on('preLobbyUpdated', ({ players }) => {
            const playerList = document.getElementById('preLobbyPlayerList');
            playerList.innerHTML = '';
    
            players.forEach((player) => {
                const playerCard = document.createElement('div');
                playerCard.className = 'border outset flex-row';
                playerCard.style.padding = '8px';
                playerCard.style.margin = '4px 0';
                playerCard.style.alignItems = 'center';
    
                // Profile picture
                const profilePic = document.createElement('img');
                profilePic.src = player.profilePictureUrl || '/images/default-avatar.png';
                profilePic.alt = 'Avatar';
                profilePic.className = 'avatar';
                profilePic.style.width = '32px';
                profilePic.style.height = '32px';
                profilePic.style.marginRight = '8px';
                profilePic.style.borderRadius = '4px';
    
                // Player info
                const info = document.createElement('div');
                info.className = 'flex-column';
                info.style.flex = '1';
    
                const nameSpan = document.createElement('span');
                nameSpan.textContent = player.username;
                nameSpan.style.fontWeight = 'bold';
    
                const skillSpan = document.createElement('span');
                skillSpan.textContent = `ELO: ${player.skill || 'Unrated'}`;
                skillSpan.style.fontSize = '0.9em';
                skillSpan.style.opacity = '0.8';
    
                info.appendChild(nameSpan);
                info.appendChild(skillSpan);
    
                playerCard.appendChild(profilePic);
                playerCard.appendChild(info);
                playerList.appendChild(playerCard);
            });
        });
    
        // Handle pre-lobby creation success
        socket.on('preLobbyCreated', ({ inviteCode }) => {
            document.getElementById('inviteCode').textContent = inviteCode;
            document.getElementById('preLobbySection').style.display = 'block';
            document.getElementById('startPreLobbyMatchmakingBtn').style.display = 'block';
        });
    
        // Start with user info fetch
        fetchUserInfo();
    </script>
    </body>
</html>
