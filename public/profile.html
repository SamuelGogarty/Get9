<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Profile</title>
    <link rel="stylesheet" href="styles.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="container">
        <h1>Welcome to Your Profile</h1>
        <p>Welcome, <span id="username">loading...</span>!</p>
        <p>Your Steam ID / Email: <span id="identifier">loading...</span></p>
        <p>Your ELO (Skill): <span id="skill">loading...</span></p>
        <img id="profilePicture" src="" alt="Profile Picture" style="display: none; width: 100px; height: 100px;">

        <button id="startMatchmakingBtn">Start Matchmaking</button>

        <!-- Pre-Lobby Controls (Visible Initially) -->
        <div id="preLobbyControls">
            <h2>Pre-Lobby</h2>
            <button id="createPreLobbyBtn">Create Pre-Lobby</button>

            <h3>Join a Pre-Lobby</h3>
            <input type="text" id="inviteCodeInput" placeholder="Enter invite code">
            <button id="joinPreLobbyBtn">Join Pre-Lobby</button>
        </div>

        <!-- Pre-Lobby Section (Hidden Initially) -->
        <div id="preLobbySection" style="display: none;">
            <p>Your Invite Code: <span id="inviteCode"></span></p>

            <h3>Players in Pre-Lobby:</h3>
            <ul id="preLobbyPlayerList"></ul>

            <button id="startPreLobbyMatchmakingBtn" style="display: none;">Start Matchmaking</button>
        </div>

        <a href="/">Go back to main page</a>
    </div>

    <script>
        const socket = io();

        function fetchUserInfo() {
            fetch('/user/info')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('username').textContent = data.username || 'Unknown user';
                    document.getElementById('identifier').textContent = data.steamId || data.email || 'No Steam ID or Email';
                    if (data.profilePictureUrl) {
                        const profilePicture = document.getElementById('profilePicture');
                        profilePicture.src = data.profilePictureUrl;
                        profilePicture.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error fetching user info:', error);
                });

            fetch('/user/skill')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('skill').textContent = data.skill || 'No skill data';
                })
                .catch(error => {
                    console.error('Error fetching player skill:', error);
                    document.getElementById('skill').textContent = 'Error loading skill';
                });
        }

        document.getElementById('startMatchmakingBtn').addEventListener('click', () => {
            const username = document.getElementById('username').textContent;
            const identifier = document.getElementById('identifier').textContent;
            const profilePictureUrl = document.getElementById('profilePicture').src;

            // Determine if the identifier is a Steam ID or Email
            const isSteamUser = identifier.startsWith('7656'); // Steam IDs typically start with '7656'

            const steamId = isSteamUser ? identifier : null;
            const email = isSteamUser ? null : identifier;

            socket.emit('startMatchmaking', { username, steamId, email, profilePictureUrl });
        });

        socket.on('redirect', (url) => {
            window.location.href = url;
        });

        // Handle error messages
        socket.on('error', (message) => {
            alert('Error: ' + message);
            // Re-enable the matchmaking button in case of error
            const button = document.getElementById('startMatchmakingBtn');
            button.disabled = false;
            button.textContent = 'Start Matchmaking';
        });

        // Pre-Lobby functionality
        document.getElementById('createPreLobbyBtn').addEventListener('click', () => {
            const user = {
                username: document.getElementById('username').textContent,
                steamId: null,
                email: document.getElementById('identifier').textContent,
                profilePictureUrl: document.getElementById('profilePicture').src,
            };
            socket.emit('createPreLobby', user);
        });

        socket.on('preLobbyCreated', ({ inviteCode }) => {
            document.getElementById('inviteCode').textContent = inviteCode;
            // Show the pre-lobby section
            document.getElementById('preLobbySection').style.display = 'block';
            document.getElementById('startPreLobbyMatchmakingBtn').style.display = 'block';
        });

        document.getElementById('joinPreLobbyBtn').addEventListener('click', () => {
            const inviteCode = document.getElementById('inviteCodeInput').value;
            const user = {
                username: document.getElementById('username').textContent,
                steamId: null,
                email: document.getElementById('identifier').textContent,
                profilePictureUrl: document.getElementById('profilePicture').src,
            };
            socket.emit('joinPreLobby', { inviteCode, user });
            // Show the pre-lobby section
            document.getElementById('preLobbySection').style.display = 'block';
        });

        socket.on('preLobbyUpdated', ({ players }) => {
            const playerList = document.getElementById('preLobbyPlayerList');
            playerList.innerHTML = '';
            players.forEach((player) => {
                const playerItem = document.createElement('li');
                playerItem.textContent = player.username;
                playerList.appendChild(playerItem);
            });
        });

        document.getElementById('startPreLobbyMatchmakingBtn').addEventListener('click', () => {
            const inviteCode = document.getElementById('inviteCode').textContent;
            socket.emit('startPreLobbyMatchmaking', { inviteCode });
        });

        fetchUserInfo();
    </script>
</body>
</html>
